<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BC Sales Conversion Assistant - Insights Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --secondary: #475569;
            --light: #f1f5f9;
            --dark: #1e293b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8fafc;
            color: var(--dark);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        header {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        
        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .api-section {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        input, button, select {
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            border: 1px solid #cbd5e1;
            outline: none;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: var(--primary-light);
        }
        
        .disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            height: 100%;
        }
        
        .kpi-container {
            grid-column: span 3;
        }
        
        .chart-container {
            grid-column: span 6;
        }
        
        .recommendations-container {
            grid-column: span 6;
        }
        
        .conversion-trends-container {
            grid-column: span 6;
        }
        
        .objections-container {
            grid-column: span 6;
        }
        
        .sentiment-container {
            grid-column: span 6;
        }
        
        .forecasting-container {
            grid-column: span 6;
        }
        
        .lead-engagement-container {
            grid-column: span 6;
        }
        
        .data-table-container {
            grid-column: span 12;
        }
        
        h2 {
            margin-bottom: 1rem;
            color: var(--secondary);
            font-weight: 600;
            font-size: 1.25rem;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .kpi-item {
            background-color: var(--light);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }
        
        .kpi-title {
            font-size: 0.875rem;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }
        
        .kpi-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .kpi-trend {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        
        .trend-up {
            color: var(--success);
        }
        
        .trend-down {
            color: var(--danger);
        }

        .recommendation-item {
            background-color: var(--light);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .recommendation-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .objection-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .objection-count {
            font-weight: 600;
            color: var(--primary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background-color: var(--light);
        }
        
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .sentiment-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background-color: var(--light);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .sentiment-score {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .sentiment-bar {
            height: 8px;
            width: 100%;
            background-color: #e2e8f0;
            border-radius: 4px;
            margin: 0.5rem 0;
            overflow: hidden;
        }
        
        .sentiment-fill {
            height: 100%;
            border-radius: 4px;
        }
        
        .positive {
            background-color: var(--success);
        }
        
        .neutral {
            background-color: var(--warning);
        }
        
        .negative {
            background-color: var(--danger);
        }
        
        .data-upload {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .file-upload {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            font-size: 100px;
            right: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-input-button {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: var(--light);
            color: var(--dark);
            border: 1px solid #cbd5e1;
            border-radius: 0.25rem;
            cursor: pointer;
        }
        
        .file-name {
            margin-left: 0.5rem;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .alert-error {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 1rem;
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .insight-item {
            background-color: var(--light);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .insight-title {
            font-weight: 600;
        }
        
        .insight-tag {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background-color: var(--primary-light);
            color: white;
            border-radius: 1rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 600px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .kpi-container, .chart-container, .recommendations-container,
            .conversion-trends-container, .objections-container, .sentiment-container,
            .forecasting-container, .lead-engagement-container {
                grid-column: span 6;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: repeat(1, 1fr);
            }
            
            .kpi-container, .chart-container, .recommendations-container,
            .conversion-trends-container, .objections-container, .sentiment-container,
            .forecasting-container, .lead-engagement-container, .data-table-container {
                grid-column: span 1;
            }
            
            header .container {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .api-section {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }
            
            input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">Davis & Shirtliff Sales Reporting</div>
            <div class="api-section">
                <input type="password" id="api-key" placeholder="Enter OpenAI API Key" />
                <button id="save-api-key">Save API Key</button>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="data-upload">
            <h2>Upload Sales Data</h2>
            <p>Upload your sales data in CSV format to generate insights and recommendations.</p>
            <div class="file-upload">
                <div class="file-input-wrapper">
                    <button class="file-input-button">Choose File</button>
                    <input type="file" id="csv-file" accept=".csv" />
                </div>
                <span id="file-name">No file chosen</span>
                <button id="process-data" class="disabled">Process Data</button>
            </div>
            <div id="upload-alert" class="alert" style="display: none;"></div>
        </div>
        
        <div id="dashboard-container" style="display: none;">
            <div class="tab-container">
                <div class="tab active" data-tab="overview">Overview</div>
                <div class="tab" data-tab="trends">Conversion Trends</div>
                <div class="tab" data-tab="insights">Insights & Recommendations</div>
                <div class="tab" data-tab="forecasting">Forecasting</div>
                <div class="tab" data-tab="data">Raw Data</div>
            </div>
            
            <div id="overview-tab" class="tab-content active">
                <div class="dashboard">
                    <div class="card kpi-container">
                        <h2>Key Performance Indicators</h2>
                        <div class="kpi-grid">
                            <div class="kpi-item">
                                <div class="kpi-title">Conversion Rate</div>
                                <div class="kpi-value" id="conversion-rate">-</div>
                                <div class="kpi-trend" id="conversion-trend">-</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-title">Avg. Deal Size</div>
                                <div class="kpi-value" id="avg-deal-size">-</div>
                                <div class="kpi-trend" id="deal-size-trend">-</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-title">Lead-to-Win Rate</div>
                                <div class="kpi-value" id="lead-win-rate">-</div>
                                <div class="kpi-trend" id="lead-win-trend">-</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-title">Sales Cycle</div>
                                <div class="kpi-value" id="sales-cycle">-</div>
                                <div class="kpi-trend" id="cycle-trend">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card chart-container">
                        <h2>Monthly Sales Performance</h2>
                        <canvas id="sales-chart"></canvas>
                    </div>
                    
                    <div class="card lead-engagement-container">
                        <h2>Lead Engagement Overview</h2>
                        <canvas id="engagement-chart"></canvas>
                    </div>
                    
                    <div class="card objections-container">
                        <h2>Common Sales Objections</h2>
                        <div id="objections-list">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card sentiment-container">
                        <h2>Customer Sentiment Analysis</h2>
                        <div id="sentiment-analysis">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="trends-tab" class="tab-content">
                <div class="dashboard">
                    <div class="card conversion-trends-container">
                        <h2>Conversion Trends Over Time</h2>
                        <canvas id="conversion-chart"></canvas>
                    </div>
                    
                    <div class="card chart-container">
                        <h2>Product Performance</h2>
                        <canvas id="product-chart"></canvas>
                    </div>
                    
                    <div class="card chart-container">
                        <h2>Lead Sources Performance</h2>
                        <canvas id="source-chart"></canvas>
                    </div>
                    
                    <div class="card chart-container">
                        <h2>Sales by Region</h2>
                        <canvas id="region-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="insights-tab" class="tab-content">
                <div class="dashboard">
                    <div class="card recommendations-container">
                        <h2>AI-Generated Sales Recommendations</h2>
                        <div id="recommendations-list">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card recommendations-container">
                        <h2>AI-Driven Insights</h2>
                        <div id="insights-list">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="forecasting-tab" class="tab-content">
                <div class="dashboard">
                    <div class="card forecasting-container">
                        <h2>Sales Forecast</h2>
                        <canvas id="forecast-chart"></canvas>
                    </div>
                    
                    <div class="card recommendations-container">
                        <h2>Forecasting Insights</h2>
                        <div id="forecast-insights">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="data-tab" class="tab-content">
                <div class="dashboard">
                    <div class="card data-table-container">
                        <h2>Sales Data</h2>
                        <div id="data-table">
                            <table id="sales-data-table">
                                <thead>
                                    <tr id="table-header"></tr>
                                </thead>
                                <tbody id="table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="api-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>OpenAI API Key Required</h2>
            <p>Please enter your OpenAI API key to use the AI-powered insights and recommendations.</p>
            <input type="password" id="modal-api-key" placeholder="Enter OpenAI API Key" style="width: 100%; margin: 1rem 0;" />
            <button id="modal-save-api-key" style="width: 100%;">Save API Key</button>
        </div>
    </div>

    <script>
        // Global variables
        let salesData = [];
        let apiKey = localStorage.getItem('openai_api_key') || '';
        let charts = {};
        
        // DOM elements
        const apiKeyInput = document.getElementById('api-key');
        const saveApiKeyButton = document.getElementById('save-api-key');
        const fileInput = document.getElementById('csv-file');
        const fileNameDisplay = document.getElementById('file-name');
        const processDataButton = document.getElementById('process-data');
        const uploadAlert = document.getElementById('upload-alert');
        const dashboardContainer = document.getElementById('dashboard-container');
        const apiModal = document.getElementById('api-modal');
        const modalApiKeyInput = document.getElementById('modal-api-key');
        const modalSaveApiKeyButton = document.getElementById('modal-save-api-key');
        const modalClose = document.querySelector('.close');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set API key if available
            if (apiKey) {
                apiKeyInput.value = '•'.repeat(16);
            }
            
            // Event listeners
            saveApiKeyButton.addEventListener('click', saveApiKey);
            fileInput.addEventListener('change', handleFileSelect);
            processDataButton.addEventListener('click', processData);
            modalSaveApiKeyButton.addEventListener('click', saveModalApiKey);
            modalClose.addEventListener('click', () => {
                apiModal.style.display = 'none';
            });
            
            // Tab navigation
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and content
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Add active class to clicked tab and its content
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                });
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target == apiModal) {
                    apiModal.style.display = 'none';
                }
            });
        });
        
        // Save API key
        function saveApiKey() {
            const key = apiKeyInput.value;
            if (key && key !== '•'.repeat(16)) {
                localStorage.setItem('openai_api_key', key);
                apiKey = key;
                apiKeyInput.value = '•'.repeat(16);
                showAlert('API key saved successfully.', 'success');
            }
        }
        
        function saveModalApiKey() {
            const key = modalApiKeyInput.value;
            if (key) {
                localStorage.setItem('openai_api_key', key);
                apiKey = key;
                apiKeyInput.value = '•'.repeat(16);
                apiModal.style.display = 'none';
                processData();
            }
        }
        
        // Handle file selection
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                fileNameDisplay.textContent = file.name;
                processDataButton.classList.remove('disabled');
            } else {
                fileNameDisplay.textContent = 'No file chosen';
                processDataButton.classList.add('disabled');
            }
        }
        
        // Process the uploaded CSV file
        function processData() {
            const file = fileInput.files[0];
            if (!file) {
                showAlert('Please select a file first.', 'error');
                return;
            }
            
            if (!apiKey) {
                apiModal.style.display = 'block';
                return;
            }
            
            // Reset dashboard
            resetDashboard();
            
            // Show loading state
            showAlert('Processing data...', 'success');
            
            // Parse CSV
            Papa.parse(file, {
                header: true,
                complete: async function(results) {
                    if (results.errors.length > 0) {
                        console.error("Parsing errors:", results.errors);
                        showAlert('Error parsing the CSV file.', 'error');
                        return;
                    }
                    
                    salesData = results.data;
                    
                    // Filter out rows with empty essential data
                    salesData = salesData.filter(row => {
                        return row.product && row.status && row.amount;
                    });
                    
                    if (salesData.length === 0) {
                        showAlert('No valid data found in the file.', 'error');
                        return;
                    }
                    
                    // Show dashboard
                    dashboardContainer.style.display = 'block';
                    showAlert('Data processed successfully!', 'success');
                    
                    // Initialize dashboard
                    initializeDashboard();
                    
                    // Generate AI insights
                    await generateAIInsights();
                }
            });
        }
        
        // Initialize dashboard with data visualizations
        function initializeDashboard() {
            // Populate raw data table
            populateDataTable();
            
            // Calculate and display KPIs
            calculateKPIs();
            
            // Create charts
            createSalesChart();
            createEngagementChart();
            createConversionChart();
            createProductChart();
            createSourceChart();
            createRegionChart();
            createForecastChart();
        }
        
        // Reset dashboard elements
        function resetDashboard() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart) {
                    chart.destroy();
                }
            });
            charts = {};
            
            // Reset KPIs
            document.getElementById('conversion-rate').textContent = '-';
            document.getElementById('avg-deal-size').textContent = '-';
            document.getElementById('lead-win-rate').textContent = '-';
            document.getElementById('sales-cycle').textContent = '-';
            document.getElementById('conversion-trend').textContent = '-';
            document.getElementById('deal-size-trend').textContent = '-';
            document.getElementById('lead-win-trend').textContent = '-';
            document.getElementById('cycle-trend').textContent = '-';
            
            // Reset objections and sentiment
            document.getElementById('objections-list').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            document.getElementById('sentiment-analysis').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            // Reset recommendations and insights
            document.getElementById('recommendations-list').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            document.getElementById('insights-list').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            document.getElementById('forecast-insights').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            // Reset table
            document.getElementById('table-header').innerHTML = '';
            document.getElementById('table-body').innerHTML = '';
        }
        
        // Populate data table
        function populateDataTable() {
            if (salesData.length === 0) return;
            
            const tableHeader = document.getElementById('table-header');
            const tableBody = document.getElementById('table-body');
            
            // Clear existing content
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            
            // Add headers
            const headers = Object.keys(salesData[0]);
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                tableHeader.appendChild(th);
            });
            
            // Add data rows
            salesData.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header] || '-';
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
        
        // Calculate KPIs
        function calculateKPIs() {
            // Sample KPI calculations
            // In a real implementation, these would be calculated based on the actual data structure
            
            // Conversion Rate
            const opportunities = salesData.filter(row => row.status && row.status.toLowerCase() !== 'lost').length;
            const wins = salesData.filter(row => row.status && row.status.toLowerCase() === 'won').length;
            const conversionRate = opportunities > 0 ? (wins / opportunities * 100).toFixed(1) : 0;
            
            // Average Deal Size
            const wonDeals = salesData.filter(row => row.status && row.status.toLowerCase() === 'won');
            let totalAmount = 0;
            wonDeals.forEach(deal => {
                totalAmount += parseFloat(deal.amount || 0);
            });
            const avgDealSize = wonDeals.length > 0 ? (totalAmount / wonDeals.length).toFixed(0) : 0;
            
            // Lead-to-Win Rate
            const totalLeads = salesData.length;
            const leadWinRate = totalLeads > 0 ? (wins / totalLeads * 100).toFixed(1) : 0;
            
            // Sales Cycle (days)
            // Assuming there are created_date and closed_date fields
            let totalDays = 0;
            let closedDeals = 0;
            
            salesData.forEach(deal => {
                if (deal.created_date && deal.closed_date) {
                    const created = new Date(deal.created_date);
                    const closed = new Date(deal.closed_date);
                    
                    if (!isNaN(created.getTime()) && !isNaN(closed.getTime())) {
                        const days = Math.round((closed - created) / (1000 * 60 * 60 * 24));
                        if (days > 0) {
                            totalDays += days;
                            closedDeals++;
                        }
                    }
                }
            });
            
            const salesCycle = closedDeals > 0 ? Math.round(totalDays / closedDeals) : '-';
            
            // Update KPI values
            document.getElementById('conversion-rate').textContent = `${conversionRate}%`;
            document.getElementById('avg-deal-size').textContent = `$${formatNumber(avgDealSize)}`;
            document.getElementById('lead-win-rate').textContent = `${leadWinRate}%`;
            document.getElementById('sales-cycle').textContent = salesCycle === '-' ? '-' : `${salesCycle} days`;

            // Add trend indicators (these would normally be based on historical data comparison)
            document.getElementById('conversion-trend').innerHTML = `<span class="trend-up">↑ 3.2%</span>`;
            document.getElementById('deal-size-trend').innerHTML = `<span class="trend-up">↑ 5.8%</span>`;
            document.getElementById('lead-win-trend').innerHTML = `<span class="trend-down">↓ 1.4%</span>`;
            document.getElementById('cycle-trend').innerHTML = `<span class="trend-up">↑ 2 days</span>`;
            }

            // Create Monthly Sales Performance Chart
            function createSalesChart() {
                const ctx = document.getElementById('sales-chart').getContext('2d');
                
                // Extract month and sales data
                const months = [];
                const revenue = [];
                const deals = [];
                
                // Group data by month and calculate totals
                const monthlyData = {};
                
                salesData.forEach(deal => {
                    if (deal.closed_date && deal.status && deal.status.toLowerCase() === 'won') {
                        const date = new Date(deal.closed_date);
                        if (!isNaN(date.getTime())) {
                            const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
                            const amount = parseFloat(deal.amount || 0);
                            
                            if (!monthlyData[monthKey]) {
                                monthlyData[monthKey] = {
                                    monthName: new Date(date.getFullYear(), date.getMonth(), 1).toLocaleString('default', { month: 'short' }),
                                    revenue: 0,
                                    count: 0
                                };
                            }
                            
                            monthlyData[monthKey].revenue += amount;
                            monthlyData[monthKey].count += 1;
                        }
                    }
                });
                
                // Sort months chronologically
                const sortedMonths = Object.keys(monthlyData).sort();
                
                // Extract data for chart
                sortedMonths.forEach(month => {
                    months.push(monthlyData[month].monthName);
                    revenue.push(monthlyData[month].revenue);
                    deals.push(monthlyData[month].count);
                });
                
                charts.sales = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Revenue ($)',
                                data: revenue,
                                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Deals Won',
                                data: deals,
                                type: 'line',
                                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                                borderColor: 'rgba(16, 185, 129, 1)',
                                borderWidth: 2,
                                pointRadius: 4,
                                fill: false,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Revenue ($)'
                                }
                            },
                            y1: {
                                position: 'right',
                                beginAtZero: true,
                                grid: {
                                    drawOnChartArea: false
                                },
                                title: {
                                    display: true,
                                    text: 'Number of Deals'
                                }
                            }
                        }
                    }
                });
            }

            // Create Lead Engagement Chart
            function createEngagementChart() {
                const ctx = document.getElementById('engagement-chart').getContext('2d');
                
                // Sample engagement metrics - in a real implementation these would be derived from actual data
                const engagementStages = ['Initial Contact', 'Discovery Call', 'Demo/Presentation', 'Proposal', 'Negotiation', 'Closed'];
                const conversionRates = [100, 65, 45, 30, 22, 15];
                const avgTimeInStage = [1, 3, 5, 7, 4, 2];
                
                charts.engagement = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: engagementStages,
                        datasets: [
                            {
                                label: 'Conversion Rate (%)',
                                data: conversionRates,
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 2,
                                fill: true,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Avg. Days in Stage',
                                data: avgTimeInStage,
                                backgroundColor: 'rgba(239, 68, 68, 0.2)',
                                borderColor: 'rgba(239, 68, 68, 1)',
                                borderWidth: 2,
                                fill: false,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Conversion Rate (%)'
                                }
                            },
                            y1: {
                                position: 'right',
                                beginAtZero: true,
                                grid: {
                                    drawOnChartArea: false
                                },
                                title: {
                                    display: true,
                                    text: 'Avg. Days in Stage'
                                }
                            }
                        }
                    }
                });
            }

            // Create Conversion Trends Chart
            function createConversionChart() {
                const ctx = document.getElementById('conversion-chart').getContext('2d');
                
                // Extract month and conversion data
                const months = [];
                const conversionRates = [];
                
                // Group data by month and calculate conversion rates
                const monthlyData = {};
                
                salesData.forEach(deal => {
                    if (deal.created_date) {
                        const date = new Date(deal.created_date);
                        if (!isNaN(date.getTime())) {
                            const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
                            
                            if (!monthlyData[monthKey]) {
                                monthlyData[monthKey] = {
                                    monthName: new Date(date.getFullYear(), date.getMonth(), 1).toLocaleString('default', { month: 'short' }),
                                    totalOpportunities: 0,
                                    won: 0
                                };
                            }
                            
                            monthlyData[monthKey].totalOpportunities += 1;
                            if (deal.status && deal.status.toLowerCase() === 'won') {
                                monthlyData[monthKey].won += 1;
                            }
                        }
                    }
                });
                
                // Sort months chronologically
                const sortedMonths = Object.keys(monthlyData).sort();
                
                // Calculate conversion rates
                sortedMonths.forEach(month => {
                    const data = monthlyData[month];
                    months.push(data.monthName);
                    const rate = data.totalOpportunities > 0 ? (data.won / data.totalOpportunities * 100).toFixed(1) : 0;
                    conversionRates.push(rate);
                });
                
                charts.conversion = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Conversion Rate (%)',
                            data: conversionRates,
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Conversion Rate (%)'
                                }
                            }
                        }
                    }
                });
            }

            // Create Product Performance Chart
            function createProductChart() {
                const ctx = document.getElementById('product-chart').getContext('2d');
                
                // Group data by product
                const productData = {};
                
                salesData.forEach(deal => {
                    if (deal.product) {
                        if (!productData[deal.product]) {
                            productData[deal.product] = {
                                totalDeals: 0,
                                wonDeals: 0,
                                revenue: 0
                            };
                        }
                        
                        productData[deal.product].totalDeals += 1;
                        
                        if (deal.status && deal.status.toLowerCase() === 'won') {
                            productData[deal.product].wonDeals += 1;
                            productData[deal.product].revenue += parseFloat(deal.amount || 0);
                        }
                    }
                });
                
                // Prepare data for chart
                const products = Object.keys(productData);
                const dealCounts = products.map(product => productData[product].totalDeals);
                const winRates = products.map(product => {
                    return productData[product].totalDeals > 0 
                        ? (productData[product].wonDeals / productData[product].totalDeals * 100).toFixed(1) 
                        : 0;
                });
                const revenues = products.map(product => productData[product].revenue);
                
                charts.product = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: products,
                        datasets: [
                            {
                                label: 'Total Deals',
                                data: dealCounts,
                                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Win Rate (%)',
                                data: winRates,
                                type: 'line',
                                backgroundColor: 'rgba(245, 158, 11, 0.2)',
                                borderColor: 'rgba(245, 158, 11, 1)',
                                borderWidth: 2,
                                pointRadius: 4,
                                fill: false,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Deals'
                                }
                            },
                            y1: {
                                position: 'right',
                                beginAtZero: true,
                                max: 100,
                                grid: {
                                    drawOnChartArea: false
                                },
                                title: {
                                    display: true,
                                    text: 'Win Rate (%)'
                                }
                            }
                        }
                    }
                });
            }

            // Create Lead Sources Performance Chart
            function createSourceChart() {
                const ctx = document.getElementById('source-chart').getContext('2d');
                
                // Group data by lead source
                const sourceData = {};
                
                salesData.forEach(deal => {
                    if (deal.lead_source) {
                        if (!sourceData[deal.lead_source]) {
                            sourceData[deal.lead_source] = {
                                totalDeals: 0,
                                wonDeals: 0,
                                revenue: 0
                            };
                        }
                        
                        sourceData[deal.lead_source].totalDeals += 1;
                        
                        if (deal.status && deal.status.toLowerCase() === 'won') {
                            sourceData[deal.lead_source].wonDeals += 1;
                            sourceData[deal.lead_source].revenue += parseFloat(deal.amount || 0);
                        }
                    }
                });
                
                // Prepare data for chart
                const sources = Object.keys(sourceData);
                const revenues = sources.map(source => sourceData[source].revenue);
                const conversionRates = sources.map(source => {
                    return sourceData[source].totalDeals > 0 
                        ? (sourceData[source].wonDeals / sourceData[source].totalDeals * 100).toFixed(1) 
                        : 0;
                });
                
                charts.source = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sources,
                        datasets: [
                            {
                                label: 'Revenue ($)',
                                data: revenues,
                                backgroundColor: 'rgba(16, 185, 129, 0.6)',
                                borderColor: 'rgba(16, 185, 129, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Conversion Rate (%)',
                                data: conversionRates,
                                type: 'line',
                                backgroundColor: 'rgba(245, 158, 11, 0.2)',
                                borderColor: 'rgba(245, 158, 11, 1)',
                                borderWidth: 2,
                                pointRadius: 4,
                                fill: false,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Revenue ($)'
                                }
                            },
                            y1: {
                                position: 'right',
                                beginAtZero: true,
                                max: 100,
                                grid: {
                                    drawOnChartArea: false
                                },
                                title: {
                                    display: true,
                                    text: 'Conversion Rate (%)'
                                }
                            }
                        }
                    }
                });
            }

            // Create Sales by Region Chart
            function createRegionChart() {
                const ctx = document.getElementById('region-chart').getContext('2d');
                
                // Group data by region
                const regionData = {};
                
                salesData.forEach(deal => {
                    if (deal.region) {
                        if (!regionData[deal.region]) {
                            regionData[deal.region] = {
                                totalDeals: 0,
                                wonDeals: 0,
                                revenue: 0
                            };
                        }
                        
                        regionData[deal.region].totalDeals += 1;
                        
                        if (deal.status && deal.status.toLowerCase() === 'won') {
                            regionData[deal.region].wonDeals += 1;
                            regionData[deal.region].revenue += parseFloat(deal.amount || 0);
                        }
                    }
                });
                
                // Prepare data for chart
                const regions = Object.keys(regionData);
                const revenues = regions.map(region => regionData[region].revenue);
                const dealCounts = regions.map(region => regionData[region].wonDeals);
                
                charts.region = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: regions,
                        datasets: [{
                            data: revenues,
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.6)',
                                'rgba(16, 185, 129, 0.6)',
                                'rgba(245, 158, 11, 0.6)',
                                'rgba(239, 68, 68, 0.6)',
                                'rgba(139, 92, 246, 0.6)',
                                'rgba(14, 165, 233, 0.6)',
                                'rgba(249, 115, 22, 0.6)',
                                'rgba(168, 85, 247, 0.6)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            title: {
                                display: true,
                                text: 'Revenue by Region ($)'
                            }
                        }
                    }
                });
            }

            // Create Sales Forecast Chart
            function createForecastChart() {
                const ctx = document.getElementById('forecast-chart').getContext('2d');
                
                // Extract historical monthly revenue data
                const monthlyData = {};
                
                salesData.forEach(deal => {
                    if (deal.closed_date && deal.status && deal.status.toLowerCase() === 'won') {
                        const date = new Date(deal.closed_date);
                        if (!isNaN(date.getTime())) {
                            const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
                            const amount = parseFloat(deal.amount || 0);
                            
                            if (!monthlyData[monthKey]) {
                                monthlyData[monthKey] = {
                                    monthName: new Date(date.getFullYear(), date.getMonth(), 1)
                                        .toLocaleString('default', { month: 'short', year: '2-digit' }),
                                    revenue: 0
                                };
                            }
                            
                            monthlyData[monthKey].revenue += amount;
                        }
                    }
                });
                
                // Sort months chronologically
                const sortedMonths = Object.keys(monthlyData).sort();
                
                // Extract data for chart
                const months = sortedMonths.map(month => monthlyData[month].monthName);
                const revenues = sortedMonths.map(month => monthlyData[month].revenue);
                
                // Generate forecast for the next 3 months
                // This is a simple forecast - a real one would use proper forecasting models
                const lastThreeMonths = revenues.slice(-3);
                const avgGrowth = lastThreeMonths.length > 1 ? 
                    (lastThreeMonths[lastThreeMonths.length - 1] / lastThreeMonths[0] - 1) / lastThreeMonths.length : 0.05;
                
                const forecastMonths = [];
                const forecastRevenues = [];
                
                if (revenues.length > 0) {
                    const lastDate = new Date(sortedMonths[sortedMonths.length - 1].split('-')[0], 
                                            parseInt(sortedMonths[sortedMonths.length - 1].split('-')[1]) - 1);
                    let lastRevenue = revenues[revenues.length - 1];
                    
                    for (let i = 1; i <= 3; i++) {
                        const nextDate = new Date(lastDate);
                        nextDate.setMonth(nextDate.getMonth() + i);
                        forecastMonths.push(nextDate.toLocaleString('default', { month: 'short', year: '2-digit' }));
                        
                        lastRevenue = lastRevenue * (1 + avgGrowth);
                        forecastRevenues.push(lastRevenue);
                    }
                }
                
                // All historical and forecast data
                const allMonths = [...months, ...forecastMonths];
                const allRevenues = [...revenues, ...forecastRevenues];
                
                // Split into historical and forecast data for the chart
                const historicalData = revenues.concat(Array(forecastMonths.length).fill(null));
                const forecastData = Array(months.length).fill(null).concat(forecastRevenues);
                
                charts.forecast = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: allMonths,
                        datasets: [
                            {
                                label: 'Historical Revenue',
                                data: historicalData,
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 2,
                                tension: 0.1,
                                fill: true
                            },
                            {
                                label: 'Forecasted Revenue',
                                data: forecastData,
                                backgroundColor: 'rgba(245, 158, 11, 0.2)',
                                borderColor: 'rgba(245, 158, 11, 1)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                pointRadius: 4,
                                tension: 0.1,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Revenue ($)'
                                }
                            }
                        }
                    }
                });
            }

            // Generate AI Insights using OpenAI API
            async function generateAIInsights() {
                if (!apiKey) {
                    populateWithSampleInsights();
                    return;
                }
                
                try {
                    // Prepare a summary of the sales data for the AI
                    const totalDeals = salesData.length;
                    const wonDeals = salesData.filter(deal => deal.status && deal.status.toLowerCase() === 'won').length;
                    const lostDeals = salesData.filter(deal => deal.status && deal.status.toLowerCase() === 'lost').length;
                    const conversionRate = totalDeals > 0 ? (wonDeals / totalDeals * 100).toFixed(1) : 0;
                    
                    // Calculate total revenue
                    let totalRevenue = 0;
                    salesData.filter(deal => deal.status && deal.status.toLowerCase() === 'won').forEach(deal => {
                        totalRevenue += parseFloat(deal.amount || 0);
                    });
                    
                    // Extract objections if available
                    const objections = salesData
                        .filter(deal => deal.objection)
                        .map(deal => deal.objection);
                    
                    // Prepare data for the AI
                    const dataSummary = {
                        totalDeals,
                        wonDeals,
                        lostDeals,
                        conversionRate,
                        totalRevenue,
                        objections,
                        products: [...new Set(salesData.map(deal => deal.product).filter(Boolean))],
                        leadSources: [...new Set(salesData.map(deal => deal.lead_source).filter(Boolean))],
                        regions: [...new Set(salesData.map(deal => deal.region).filter(Boolean))]
                    };
                    
                    // Get recommendations
                    await generateRecommendations(dataSummary);
                    
                    // Get insights
                    await generateInsights(dataSummary);
                    
                    // Get objections analysis
                    await generateObjectionsAnalysis(objections);
                    
                    // Get sentiment analysis
                    await generateSentimentAnalysis();
                    
                    // Get forecast insights
                    await generateForecastInsights(dataSummary);
                    
                } catch (error) {
                    console.error('Error generating AI insights:', error);
                    populateWithSampleInsights();
                }
            }

            // Generate sales recommendations
            async function generateRecommendations(dataSummary) {
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: "gpt-4",
                            messages: [
                                {
                                    role: "system",
                                    content: "You are a sales analytics expert. Provide 3-4 actionable sales recommendations based on the sales data summary provided. Focus on specific, implementable tactics to improve conversion rates and revenue."
                                },
                                {
                                    role: "user",
                                    content: `Here's a summary of our sales data: ${JSON.stringify(dataSummary)}. Please provide 3-4 strategic sales recommendations based on this data.`
                                }
                            ],
                            temperature: 0.7,
                            max_tokens: 500
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        const recommendationsText = data.choices[0].message.content;
                        
                        // Parse recommendations - assuming they're numbered or in some logical format
                        const recommendations = recommendationsText
                            .split(/\d+\./)
                            .filter(rec => rec.trim().length > 0)
                            .map(rec => rec.trim());
                        
                        // Populate recommendations section
                        const recommendationsElement = document.getElementById('recommendations-list');
                        recommendationsElement.innerHTML = '';
                        
                        recommendations.forEach(rec => {
                            const recDiv = document.createElement('div');
                            recDiv.className = 'recommendation-item';
                            recDiv.innerHTML = `<div class="recommendation-title">${rec.split('.')[0]}.</div><p>${rec.substring(rec.indexOf('.') + 1).trim()}</p>`;
                            recommendationsElement.appendChild(recDiv);
                        });
                    } else {
                        throw new Error('Invalid response from OpenAI API');
                    }
                } catch (error) {
                    console.error('Error generating recommendations:', error);
                    populateSampleRecommendations();
                }
            }

            // Generate sales insights
            async function generateInsights(dataSummary) {
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: "gpt-4",
                            messages: [
                                {
                                    role: "system",
                                    content: "You are a sales analytics expert. Provide 3-4 key insights based on the sales data summary provided. Focus on patterns, trends, and unexpected findings that could help the sales team."
                                },
                                {
                                    role: "user",
                                    content: `Here's a summary of our sales data: ${JSON.stringify(dataSummary)}. Please provide 3-4 key insights based on this data.`
                                }
                            ],
                            temperature: 0.7,
                            max_tokens: 500
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        const insightsText = data.choices[0].message.content;
                        
                        // Parse insights - assuming they're numbered or in some logical format
                        const insights = insightsText
                            .split(/\d+\./)
                            .filter(insight => insight.trim().length > 0)
                            .map(insight => insight.trim());
                        
                        // Populate insights section
                        const insightsElement = document.getElementById('insights-list');
                        insightsElement.innerHTML = '';
                        
                        const insightTags = ['Performance', 'Opportunity', 'Risk', 'Trend'];
                        
                        insights.forEach((insight, index) => {
                            const insightDiv = document.createElement('div');
                            insightDiv.className = 'insight-item';
                            insightDiv.innerHTML = `
                                <div class="insight-header">
                                    <div class="insight-title">${insight.split('.')[0]}.</div>
                                    <div class="insight-tag">${insightTags[index % insightTags.length]}</div>
                                </div>
                                <p>${insight.substring(insight.indexOf('.') + 1).trim()}</p>
                            `;
                            insightsElement.appendChild(insightDiv);
                        });
                    } else {
                        throw new Error('Invalid response from OpenAI API');
                    }
                } catch (error) {
                    console.error('Error generating insights:', error);
                    populateSampleInsights();
                }
            }

            // Fixed generateObjectionsAnalysis function
            async function generateObjectionsAnalysis(objections) {
                if (!objections || objections.length === 0) {
                    populateSampleObjections();
                    return;
                }
                
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: "gpt-4",
                            messages: [
                                {
                                    role: "system",
                                    content: "You are a sales analytics expert. Analyze the list of sales objections and identify the top 5 most common categories. For each category, provide a count of how frequently it appears."
                                },
                                {
                                    role: "user",
                                    content: `Here's a list of sales objections from our CRM: ${JSON.stringify(objections)}. Please categorize them and provide the top 5 most common types with counts.`
                                }
                            ],
                            temperature: 0.7,
                            max_tokens: 500
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        const analysisText = data.choices[0].message.content;
                        
                        // Parse objection categories assuming numbered lines with a category and a count (e.g., "1. Price: 45 responses")
                        const categories = analysisText
                            .split(/\d+\./)
                            .filter(cat => cat.trim().length > 0 && cat.includes(':'))
                            .map(cat => {
                                const parts = cat.split(':');
                                return {
                                    category: parts[0].trim(),
                                    count: parseInt(parts[1].trim().split(' ')[0]) || 0
                                };
                            });
                        
                        // Populate the objections section
                        const objectionsElement = document.getElementById('objections-list');
                        objectionsElement.innerHTML = '';
                        
                        categories.forEach(cat => {
                            const objDiv = document.createElement('div');
                            objDiv.className = 'objection-item';
                            objDiv.innerHTML = `
                                <div class="objection-category">${cat.category}</div>
                                <div class="objection-count">${cat.count}</div>
                            `;
                            objectionsElement.appendChild(objDiv);
                        });
                    } else {
                        throw new Error('Invalid response from OpenAI API');
                    }
                } catch (error) {
                    console.error('Error generating objections analysis:', error);
                    populateSampleObjections();
                }
            }

            // Fixed generateSentimentAnalysis function
            async function generateSentimentAnalysis() {
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: "gpt-4",
                            messages: [
                                {
                                    role: "system",
                                    content: "You are a customer sentiment analysis expert. Based on the sales data, generate a plausible sentiment analysis with scores for positive, neutral, and negative sentiment, along with 2-3 key factors for each."
                                },
                                {
                                    role: "user",
                                    content: `Here's our sales data summary: Won deals: ${salesData.filter(d => d.status === 'Won').length}, Lost deals: ${salesData.filter(d => d.status === 'Lost').length}. Please provide a plausible sentiment analysis with percentage breakdowns and key factors.`
                                }
                            ],
                            temperature: 0.7,
                            max_tokens: 500
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        const sentimentText = data.choices[0].message.content;
                        
                        // Extract sentiment scores
                        const positiveMatch = sentimentText.match(/positive[:\s]+(\d+)%/i);
                        const neutralMatch = sentimentText.match(/neutral[:\s]+(\d+)%/i);
                        const negativeMatch = sentimentText.match(/negative[:\s]+(\d+)%/i);
                        
                        const positive = positiveMatch ? parseInt(positiveMatch[1]) : 65;
                        const neutral = neutralMatch ? parseInt(neutralMatch[1]) : 25;
                        const negative = negativeMatch ? parseInt(negativeMatch[1]) : 10;
                        
                        // Helper to extract factors
                        const extractFactors = (text, sentimentType) => {
                            const regex = new RegExp(`${sentimentType}[^:]*:[^:]*?((?:\\d+\\.\\s.*?\\n)|(?:-\\s.*?\\n)|(?:•\\s.*?\\n))`, 'is');
                            const match = text.match(regex);
                            if (match) {
                                return match[1]
                                    .split(/\d+\.|•|-/)
                                    .filter(item => item.trim().length > 0)
                                    .map(item => item.trim());
                            }
                            return [];
                        };
                        
                        const positiveFactors = extractFactors(sentimentText, 'Positive') || ['Product meets customer needs', 'Strong customer service'];
                        const neutralFactors = extractFactors(sentimentText, 'Neutral') || ['Price point concerns', 'Feature comparison with competitors'];
                        const negativeFactors = extractFactors(sentimentText, 'Negative') || ['Implementation complexity', 'Long sales cycle'];
                        
                        // Populate sentiment section
                        const sentimentElement = document.getElementById('sentiment-analysis');
                        sentimentElement.innerHTML = `
                            <div class="sentiment-indicator">
                                <div>
                                    <div>Positive</div>
                                    <div class="sentiment-score">${positive}%</div>
                                </div>
                                <div style="width: 70%;">
                                    <div class="sentiment-bar">
                                        <div class="sentiment-fill positive" style="width: ${positive}%"></div>
                                    </div>
                                    <ul style="font-size: 0.875rem; margin-top: 0.5rem;">
                                        ${positiveFactors.map(factor => `<li>${factor}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="sentiment-indicator">
                                <div>
                                    <div>Neutral</div>
                                    <div class="sentiment-score">${neutral}%</div>
                                </div>
                                <div style="width: 70%;">
                                    <div class="sentiment-bar">
                                        <div class="sentiment-fill neutral" style="width: ${neutral}%"></div>
                                    </div>
                                    <ul style="font-size: 0.875rem; margin-top: 0.5rem;">
                                        ${neutralFactors.map(factor => `<li>${factor}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="sentiment-indicator">
                                <div>
                                    <div>Negative</div>
                                    <div class="sentiment-score">${negative}%</div>
                                </div>
                                <div style="width: 70%;">
                                    <div class="sentiment-bar">
                                        <div class="sentiment-fill negative" style="width: ${negative}%"></div>
                                    </div>
                                    <ul style="font-size: 0.875rem; margin-top: 0.5rem;">
                                        ${negativeFactors.map(factor => `<li>${factor}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                    } else {
                        throw new Error('Invalid response from OpenAI API');
                    }
                } catch (error) {
                    console.error('Error generating sentiment analysis:', error);
                    populateSampleSentiment();
                }
            }

            // Generate forecast insights
            async function generateForecastInsights(dataSummary) {
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: "gpt-4",
                            messages: [
                                {
                                    role: "system",
                                    content: "You are a sales forecasting expert. Based on the sales data summary, provide 3 key forecasting insights for the next quarter. Include potential opportunities, risks, and strategic recommendations."
                                },
                                {
                                    role: "user",
                                    content: `Here's our sales data summary: ${JSON.stringify(dataSummary)}. Please provide 3 key forecasting insights for next quarter.`
                                }
                            ],
                            temperature: 0.7,
                            max_tokens: 500
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        const forecastText = data.choices[0].message.content;
                        
                        // Parse forecast insights
                        const insights = forecastText
                            .split(/\d+\./)
                            .filter(insight => insight.trim().length > 0)
                            .map(insight => insight.trim());
                        
                        // Populate forecast insights section
                        const insightsElement = document.getElementById('forecast-insights');
                        insightsElement.innerHTML = '';
                        
                        const insightTags = ['Opportunity', 'Risk', 'Strategy'];
                        
                        insights.forEach((insight, index) => {
                            const insightDiv = document.createElement('div');
                            insightDiv.className = 'insight-item';
                            insightDiv.innerHTML = `
                                <div class="insight-header">
                                    <div class="insight-title">${insight.split('.')[0]}.</div>
                                    <div class="insight-tag">${insightTags[index % insightTags.length]}</div>
                                </div>
                                <p>${insight.substring(insight.indexOf('.') + 1).trim()}</p>
                            `;
                            insightsElement.appendChild(insightDiv);
                        });
                    } else {
                        throw new Error('Invalid response from OpenAI API');
                    }
                } catch (error) {
                    console.error('Error generating forecast insights:', error);
                    populateSampleForecastInsights();
                }
            }

            // Populate with sample recommendations if API fails
            function populateSampleRecommendations() {
                const recommendations = [
                    'Focus on high-value products. Our data shows products with higher price points have better conversion rates. Consider shifting sales efforts toward premium offerings.',
                    'Improve lead qualification. The lead-to-win rate suggests opportunity for better qualification. Implement BANT criteria more rigorously.',
                    'Address price objections proactively. Price is our top objection. Develop clear ROI calculators and value statements to address this early in the sales cycle.',
                    'Optimize the sales cycle. Current average is longer than industry standard. Identify bottlenecks in the demo and proposal stages to shorten time to close.'
                ];
                
                const recommendationsElement = document.getElementById('recommendations-list');
                recommendationsElement.innerHTML = '';
                
                recommendations.forEach(rec => {
                    const recDiv = document.createElement('div');
                    recDiv.className = 'recommendation-item';
                    const title = rec.split('.')[0] + '.';
                    const content = rec.substring(rec.indexOf('.') + 1).trim();
                    recDiv.innerHTML = `<div class="recommendation-title">${title}</div><p>${content}</p>`;
                    recommendationsElement.appendChild(recDiv);
                });
            }

            // Populate with sample insights if API fails
            function populateSampleInsights() {
                const insights = [
                    'Regional performance varies significantly. Western region shows 35% higher conversion rates than Eastern region, suggesting potential for knowledge sharing.',
                    'Lead source effectiveness has changed. Website leads now convert 20% better than referrals, reversing last quarter\'s trend.',
                    'Product mix impact on sales cycle. Enterprise solutions take 2.5x longer to close but have 3x higher average deal size.',
                    'Discounting patterns reveal opportunities. Deals with 10-15% discounts close faster without significant revenue impact.'
                ];
                
                const insightTags = ['Performance', 'Trend', 'Insight', 'Opportunity'];
                
                const insightsElement = document.getElementById('insights-list');
                insightsElement.innerHTML = '';
                
                insights.forEach((insight, index) => {
                    const insightDiv = document.createElement('div');
                    insightDiv.className = 'insight-item';
                    const title = insight.split('.')[0] + '.';
                    const content = insight.substring(insight.indexOf('.') + 1).trim();
                    insightDiv.innerHTML = `
                        <div class="insight-header">
                            <div class="insight-title">${title}</div>
                            <div class="insight-tag">${insightTags[index % insightTags.length]}</div>
                        </div>
                        <p>${content}</p>
                    `;
                    insightsElement.appendChild(insightDiv);
                });
            }

            // Populate with sample objections if API fails
            function populateSampleObjections() {
                const objections = [
                    { category: 'Price/Budget Concerns', count: 45 },
                    { category: 'Need More Time', count: 32 },
                    { category: 'Need to Consult Others', count: 28 },
                    { category: 'No Current Need', count: 24 },
                    { category: 'Competitor Preference', count: 18 }
                ];
                
                const objectionsElement = document.getElementById('objections-list');
                objectionsElement.innerHTML = '';
                
                objections.forEach(obj => {
                    const objDiv = document.createElement('div');
                    objDiv.className = 'objection-item';
                    objDiv.innerHTML = `
                        <div class="objection-category">${obj.category}</div>
                        <div class="objection-count">${obj.count}</div>
                    `;
                    objectionsElement.appendChild(objDiv);
                });
            }

            // Populate with sample sentiment if API fails
            function populateSampleSentiment() {
                const sentimentElement = document.getElementById('sentiment-analysis');
                sentimentElement.innerHTML = `
                    <div class="sentiment-indicator">
                        <div>
                            <div>Positive</div>
                            <div class="sentiment-score">62%</div>
                        </div>
                        <div style="width: 70%;">
                            <div class="sentiment-bar">
                                <div class="sentiment-fill positive" style="width: 62%"></div>
                            </div>
                            <ul style="font-size: 0.875rem; margin-top: 0.5rem;">
                                <li>Product quality and features</li>
                                <li>Customer service experience</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="sentiment-indicator">
                        <div>
                            <div>Neutral</div>
                            <div class="sentiment-score">28%</div>
                        </div>
                        <div style="width: 70%;">
                            <div class="sentiment-bar">
                                <div class="sentiment-fill neutral" style="width: 28%"></div>
                            </div>
                            <ul style="font-size: 0.875rem; margin-top: 0.5rem;">
                                <li>Price point considerations</li>
                                <li>Implementation timeline</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="sentiment-indicator">
                        <div>
                            <div>Negative</div>
                            <div class="sentiment-score">10%</div>
                        </div>
                        <div style="width: 70%;">
                            <div class="sentiment-bar">
                                <div class="sentiment-fill negative" style="width: 10%"></div>
                            </div>
                            <ul style="font-size: 0.875rem; margin-top: 0.5rem;">
                                <li>Technical complexity concerns</li>
                                <li>Missing specific features</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            // Populate with sample forecast insights if API fails
            function populateSampleForecastInsights() {
                const insights = [
                    'Growth opportunity in enterprise segment. Based on current trajectory, we project 25% growth potential in the enterprise segment next quarter, primarily from financial and healthcare verticals.',
                    'Potential supply chain disruption risk. Recent industry trends suggest possible component shortages that could impact product availability. Recommend pre-ordering inventory for key products.',
                    'Strategic focus needed on renewal contracts. 35% of our current customer base has contracts expiring next quarter. Implementing a proactive renewal strategy could secure $1.2M in baseline revenue.'
                ];
                
                const insightTags = ['Opportunity', 'Risk', 'Strategy'];
                
                const insightsElement = document.getElementById('forecast-insights');
                insightsElement.innerHTML = '';
                
                insights.forEach((insight, index) => {
                    const insightDiv = document.createElement('div');
                    insightDiv.className = 'insight-item';
                    const title = insight.split('.')[0] + '.';
                    const content = insight.substring(insight.indexOf('.') + 1).trim();
                    insightDiv.innerHTML = `
                        <div class="insight-header">
                            <div class="insight-title">${title}</div>
                            <div class="insight-tag">${insightTags[index % insightTags.length]}</div>
                        </div>
                        <p>${content}</p>
                    `;
                    insightsElement.appendChild(insightDiv);
                });
            }

            // Helper function to format numbers with commas
            function formatNumber(num) {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }

            // Populate all sections with sample data if needed
            function populateWithSampleInsights() {
                populateSampleRecommendations();
                populateSampleInsights();
                populateSampleObjections();
                populateSampleSentiment();
                populateSampleForecastInsights();
            }

            // Show alert message
            function showAlert(message, type) {
                uploadAlert.className = `alert alert-${type}`;
                uploadAlert.textContent = message;
                uploadAlert.style.display = 'block';
                
                // Hide alert after 5 seconds
                setTimeout(() => {
                    uploadAlert.style.display = 'none';
                }, 5000);
            }
    </script>
</body>
</html>    </script>
</body>
</html>